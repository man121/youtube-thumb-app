<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Thumbnail Generator</title>
  <style>
    :root { --bg:#f8fafc; --text:#0f172a; --muted:#475569; --primary:#0ea5e9; --secondary:#1e293b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1200px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1fr 2fr;gap:16px}
    @media (max-width:980px){.container{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .card__body{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:12px}
    .notice{font-size:12px;color:#9ca3af}
    label{font-size:14px;display:block;margin-bottom:4px}
    input[type=text],textarea,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px}
    input[type=color]{width:100%;height:38px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0}
    input[type=file]{width:100%}
    input[type=range]{width:100%}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btnbar{display:flex;flex-wrap:wrap;gap:8px}
    .preview-wrap{display:flex;justify-content:center}
    .canvas-shell{border:1px solid #e5e7eb;background:#fff;border-radius:14px;padding:8px;box-shadow:inset 0 1px 4px rgba(0,0,0,.05);position:relative}
    .tests{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;color:#d1e5ff;padding:12px;border-radius:10px;white-space:pre-wrap;max-height:180px;overflow:auto}
    .header{padding:8px 16px}
    h1{font-size:22px;margin:0 0 6px}
    /* spinner overlay */
    .loading-overlay{position:absolute;inset:8px;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.55);backdrop-filter:blur(1px);border-radius:12px;z-index:10}
    .loading-overlay.active{display:flex}
    .spinner{width:42px;height:42px;border:4px solid #e5e7eb;border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (prefers-reduced-motion:reduce){.spinner{animation:none}}
  </style>
</head>
<body>
  <div class="header">
    <h1>YouTube Thumbnail Generator</h1>
    <div class="muted">Single-file HTML • 1280×720 export • AI via <code>/.netlify/functions/image-gen</code></div>
  </div>

  <div class="container">
    <!-- Controls -->
    <div class="card"><div class="card__body">
      <div class="mb-3 muted">Sources</div>
      <div class="mb-3">
        <label for="ytUrl">YouTube URL or ID</label>
        <div class="row">
          <input id="ytUrl" type="text" placeholder="https://youtube.com/watch?v=... or 11-char ID" />
          <button id="btnUseYT" class="btn">Use video thumbnail</button>
        </div>
        <div class="notice">We fetch from <code>img.youtube.com</code>. Export may fail due to CORS; use Upload or AI for exporting.</div>
      </div>

      <div class="mb-3">
        <label>Upload background image</label>
        <input id="fileBg" type="file" accept="image/*" />
      </div>

      <div class="mb-4">
        <label for="aiPrompt">AI Background Prompt</label>
        <textarea id="aiPrompt" rows="2" placeholder="e.g., epic neon cyberpunk city, high contrast, bokeh"></textarea>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="imgSize">Quality</label>
            <select id="imgSize">
              <option value="1024x1024" selected>Fast (1024×1024)</option>
              <option value="1536x1024">Detailed (1536×1024)</option>
              <option value="1024x1536">Portrait (1024×1536)</option>
              <option value="auto">Auto</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end">
            <button id="btnAI" class="btn" style="width:100%">Generate (OpenAI Images)</button>
          </div>
        </div>
        <div class="notice">
          Requires <code>OPENAI_API_KEY</code> on Netlify and the function at <code>netlify/functions/image-gen.js</code>.
          Endpoint: <code id="aiEndpointLabel">detecting…</code>
        </div>
      </div>

      <div class="mb-3" style="border-top:1px solid #e5e7eb; padding-top: 12px;">
        <div class="row">
          <div><label>Title</label><input id="title" type="text" value="How to Build a Thumbnail Generator" /></div>
          <div><label>Subtitle</label><input id="subtitle" type="text" value="Step-by-step in 10 minutes" /></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div><label>Title size (<span id="lblTitleSize">120</span>px)</label><input id="titleSize" type="range" min="48" max="160" step="1" value="120" /></div>
          <div><label>Subtitle size (<span id="lblSubtitleSize">56</span>px)</label><input id="subtitleSize" type="range" min="28" max="96" step="1" value="56" /></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div><label>Stroke width (<span id="lblStroke">8</span>px)</label><input id="strokeWidth" type="range" min="0" max="16" step="1" value="8" /></div>
          <div><label>Shadow</label><select id="shadow"><option value="on" selected>On</option><option value="off">Off</option></select></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div><label>Layout</label><select id="layout"><option value="left" selected>Left</option><option value="center">Center</option><option value="right">Right</option></select></div>
          <div><label>Background Fit</label><select id="fit"><option value="cover" selected>Cover</option><option value="contain">Contain</option><option value="stretch">Stretch</option></select></div>
        </div>
      </div>

      <div class="mb-3">
        <div class="row-3">
          <div><label>Primary</label><input id="colorPrimary" type="color" value="#0ea5e9" /></div>
          <div><label>Secondary</label><input id="colorSecondary" type="color" value="#1e293b" /></div>
          <div><label>Text</label><input id="colorText" type="color" value="#ffffff" /></div>
        </div>
      </div>

      <div class="mb-3">
        <label>Logo (optional)</label>
        <input id="fileLogo" type="file" accept="image/*" />
      </div>

      <div class="mb-3">
        <label class="mb-2">Templates</label>
        <div class="btnbar">
          <button id="tplElementary" class="btn">PBMA • Elementary (Reef)</button>
          <button id="tplSecondary" class="btn">PBMA • Secondary (Navy)</button>
          <button id="tplAthletics" class="btn">PBMA • Athletics (Bold)</button>
        </div>
      </div>

      <div class="btnbar">
        <button id="btnExport" class="btn primary">Export PNG</button>
      </div>

      <div class="muted" style="border-top:1px solid #e5e7eb;margin-top:12px;padding-top:12px">Tests (dev):</div>
      <div id="tests" class="tests"></div>
    </div></div>

    <!-- Preview -->
    <div class="card"><div class="card__body preview-wrap">
      <div class="canvas-shell" aria-live="polite">
        <canvas id="canvas" width="1280" height="720" style="width:640px;height:360px;display:block;"></canvas>
        <div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
          <div class="spinner" role="status" aria-label="Generating image…"></div>
        </div>
      </div>
    </div></div>
  </div>

  <script>
    const W=1280,H=720; const $=id=>document.getElementById(id);

    // === Endpoint (single, correct path) ===
    const FN_PATH = '/.netlify/functions/image-gen';
    const lbl = $('aiEndpointLabel'); if (lbl) lbl.textContent = location.origin + FN_PATH;

    // ===== Helpers =====
    function extractYouTubeId(input){
      try{
        const s=(input||'').trim();
        if(/^[A-Za-z0-9_-]{11}$/.test(s)) return s;
        const url=new URL(s); const host=url.hostname.replace(/^www\./,'');
        if(host==='youtu.be'){
          const seg=url.pathname.replace(/^\//,'').split('/')[0];
          return /^[A-Za-z0-9_-]{11}$/.test(seg)?seg:null;
        }
        if(host.endsWith('youtube.com')){
          const v=url.searchParams.get('v');
          if(v && /^[A-Za-z0-9_-]{11}$/.test(v)) return v;
          const m=url.pathname.match(/\/(shorts|embed|live)\/([A-Za-z0-9_-]{11})(?:\b|\/|$)/);
          if(m) return m[2];
        }
        return null;
      }catch{return null;}
    }
    function loadImage(src,{crossOrigin}={}){return new Promise((res,rej)=>{const img=new Image();if(crossOrigin)img.crossOrigin=crossOrigin;img.onload=()=>res(img);img.onerror=e=>rej(e);img.src=src;});}
    function coverContainRect(sw,sh,dw,dh,mode='cover'){
      if(mode==='stretch') return {sx:0,sy:0,sWidth:sw,sHeight:sh,dx:0,dy:0,dWidth:dw,dHeight:dh};
      const sr=sw/sh, dr=dw/dh;
      if(mode==='cover'){let sW,sH,sx,sy;if(sr>dr){sH=sh;sW=dr*sH;sx=(sw-sW)/2;sy=0;}else{sW=sw;sH=sW/dr;sx=0;sy=(sh-sH)/2;}return {sx,sy,sWidth:sW,sHeight:sH,dx:0,dy:0,dWidth:dw,dHeight:dh};}
      let dW,dH,dx,dy;if(sr>dr){dW=dw;dH=dW/sr;dx=0;dy=(dh-dH)/2;}else{dH=dh;dW=dH*sr;dy=0;dx=(dw-dW)/2;}return {sx:0,sy:0,sWidth:sw,sHeight:sh,dx,dy,dWidth:dW,dHeight:dH};
    }
    function wrapText(ctx,text,maxWidth,font){
      if(!text||!text.trim())return[];ctx.save();ctx.font=font;const words=text.split(/\s+/);const lines=[];let line='';
      for(const w of words){const test=line?line+' '+w:w;if(ctx.measureText(test).width<=maxWidth){line=test;}else{if(line)lines.push(line);line=w;}}
      if(line)lines.push(line);ctx.restore();return lines;
    }
    function applyPromptPalette(prompt){
      const p=(prompt||'').toLowerCase();
      const palettes=[
        {match:/cyber|neon|punk/,primary:'#ff006e',secondary:'#3a0ca3'},
        {match:/ocean|wave|blue/,primary:'#0ea5e9',secondary:'#082f49'},
        {match:/forest|green|nature/,primary:'#22c55e',secondary:'#064e3b'},
        {match:/sunset|orange|gold/,primary:'#f59e0b',secondary:'#7c2d12'},
        {match:/pink|magenta|rose/,primary:'#ec4899',secondary:'#831843'}
      ];
      const f=palettes.find(x=>x.match.test(p))||palettes[0];
      state.primary=f.primary; state.secondary=f.secondary; state.bgImg=null; draw();
    }
    function setLoading(on){
      const overlay=$('loadingOverlay'); const btn=$('btnAI');
      if(!btn.dataset.label) btn.dataset.label=btn.textContent;
      btn.disabled=on; btn.textContent=on?'Generating…':btn.dataset.label;
      overlay.classList.toggle('active',on);
      overlay.setAttribute('aria-hidden',String(!on));
      overlay.parentElement.setAttribute('aria-busy',String(on));
    }

    async function callImageAPI(body){
      const res = await fetch(FN_PATH, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      return {res, ep: FN_PATH};
    }

    // ===== Draw =====
    function draw(){
      const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,W,H);
      if(state.bgImg){const r=coverContainRect(state.bgImg.naturalWidth,state.bgImg.naturalHeight,W,H,state.fit);try{ctx.drawImage(state.bgImg,r.sx,r.sy,r.sWidth,r.sHeight,r.dx,r.dy,r.dWidth,r.dHeight);}catch{}}
      else{const g=ctx.createLinearGradient(0,0,0,H);g.addColorStop(0,state.secondary);g.addColorStop(1,state.primary);ctx.fillStyle=g;ctx.fillRect(0,0,W,H);}
      ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(0,H*0.55,W,H*0.45);

      const pad=64, textW=W-pad*2, align=state.layout;
      const titleFont=`bold ${state.titleSize}px Bebas Neue, Impact, Arial Black, sans-serif`;
      const subFont=`bold ${state.subtitleSize}px Bebas Neue, Impact, Arial Black, sans-serif`;
      function drawLines(lines,startY,fs){
        const lh=Math.round(fs*1.05); let y=startY;
        for(const line of lines){
          const w=ctx.measureText(line).width;
          let x=pad; if(align==='center')x=(W-w)/2; else if(align==='right')x=W-pad-w;
          if(state.shadow==='on'){ctx.shadowColor='#000';ctx.shadowBlur=16;ctx.shadowOffsetX=2;ctx.shadowOffsetY=4;}else{ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;}
          if(state.strokeWidth>0){ctx.lineWidth=state.strokeWidth;ctx.strokeStyle=state.secondary;ctx.strokeText(line,x,y);}
          ctx.fillStyle=state.text; ctx.fillText(line,x,y); y+=lh;
        }
        return y;
      }
      ctx.font=titleFont; ctx.textBaseline='top';
      const titleLines=wrapText(ctx,state.title,textW,titleFont);
      let nextY=drawLines(titleLines,H*0.58,state.titleSize);
      if((state.subtitle||'').trim()){
        ctx.font=subFont; ctx.textBaseline='top';
        const subLines=wrapText(ctx,state.subtitle,textW,subFont);
        nextY=drawLines(subLines,nextY+16,state.subtitleSize);
      }
      if(state.logoImg){
        const max=200; const r=coverContainRect(state.logoImg.naturalWidth,state.logoImg.naturalHeight,max,max,'contain');
        ctx.drawImage(state.logoImg,r.sx,r.sy,r.sWidth,r.sHeight,24,24,r.dWidth,r.dHeight);
      }
    }

    // ===== State =====
    const state={
      primary:'#0ea5e9', secondary:'#1e293b', text:'#ffffff',
      title:'How to Build a Thumbnail Generator', subtitle:'Step-by-step in 10 minutes',
      titleSize:120, subtitleSize:56, strokeWidth:8, shadow:'on',
      layout:'left', fit:'cover', bgImg:null, logoImg:null
    };
    const canvas=$('canvas');

    // ===== Wiring =====
    $('title').addEventListener('input',e=>{state.title=e.target.value;draw()});
    $('subtitle').addEventListener('input',e=>{state.subtitle=e.target.value;draw()});
    $('titleSize').addEventListener('input',e=>{state.titleSize=+e.target.value;$('lblTitleSize').textContent=state.titleSize;draw()});
    $('subtitleSize').addEventListener('input',e=>{state.subtitleSize=+e.target.value;$('lblSubtitleSize').textContent=state.subtitleSize;draw()});
    $('strokeWidth').addEventListener('input',e=>{state.strokeWidth=+e.target.value;$('lblStroke').textContent=state.strokeWidth;draw()});
    $('shadow').addEventListener('change',e=>{state.shadow=e.target.value;draw()});
    $('layout').addEventListener('change',e=>{state.layout=e.target.value;draw()});
    $('fit').addEventListener('change',e=>{state.fit=e.target.value;draw()});
    $('colorPrimary').addEventListener('input',e=>{state.primary=e.target.value;draw()});
    $('colorSecondary').addEventListener('input',e=>{state.secondary=e.target.value;draw()});
    $('colorText').addEventListener('input',e=>{state.text=e.target.value;draw()});

    $('fileBg').addEventListener('change',async e=>{
      const file=e.target.files && e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=async ()=>{try{state.bgImg=await loadImage(reader.result);draw();}catch{alert('Could not load image.');}};
      reader.readAsDataURL(file);
    });
    $('fileLogo').addEventListener('change',async e=>{
      const file=e.target.files && e.target.files[0];
      if(!file){state.logoImg=null;draw();return;}
      const reader=new FileReader();
      reader.onload=async ()=>{try{state.logoImg=await loadImage(reader.result);draw();}catch{alert('Could not load logo image.');}};
      reader.readAsDataURL(file);
    });

    $('btnUseYT').addEventListener('click', async ()=>{
      const id=extractYouTubeId($('ytUrl').value);
      if(!id){alert('Please paste a full YouTube URL or a valid 11-char video ID.');return;}
      const list=[
        `https://img.youtube.com/vi/${id}/maxresdefault.jpg`,
        `https://img.youtube.com/vi/${id}/sddefault.jpg`,
        `https://img.youtube.com/vi/${id}/hqdefault.jpg`,
        `https://img.youtube.com/vi/${id}/default.jpg`
      ];
      let loaded=null,lastErr=null;
      for(const u of list){try{loaded=await loadImage(u,{crossOrigin:'anonymous'});break;}catch(e){lastErr=e;}}
      if(!loaded){console.error(lastErr);alert('Could not load YouTube thumbnail. Try another video, upload a screenshot, or use AI Generate.');return;}
      state.bgImg=loaded; draw();
    });

    $('btnAI').addEventListener('click', async ()=>{
      const prompt=$('aiPrompt').value||'high-contrast abstract ocean waves, vivid, cinematic lighting';
      const size=($('imgSize')?.value)||'1024x1024';
      setLoading(true);
      try{
        const { res, ep } = await callImageAPI({ prompt, size });
        if(!res.ok){
          const txt=await res.text();
          if(res.status===402||res.status===403||res.status===504){
            applyPromptPalette(prompt);
            alert(`AI image unavailable right now (status ${res.status}).\n${txt}\n(Endpoint: ${ep})\nUsing a styled gradient instead so you can keep designing.`);
            return;
          }
          alert(`Could not generate an AI background.\nServer responded ${res.status}: ${txt}\n(Endpoint tried: ${ep})`);
          return;
        }
        const blob=await res.blob(); const url=URL.createObjectURL(blob);
        try{state.bgImg=await loadImage(url);draw();}finally{setTimeout(()=>URL.revokeObjectURL(url),2000);}
      }catch(e){
        console.error('AI fetch failed:',e);
        applyPromptPalette(prompt);
        alert(`Network error calling the image function.\n${e.message||e}\nUsing a styled gradient instead so you can continue.`);
      }finally{ setLoading(false); }
    });

    $('btnExport').addEventListener('click',()=>{
      try{
        const dataUrl=canvas.toDataURL('image/png');
        const a=document.createElement('a'); a.href=dataUrl; a.download=`thumbnail-${Date.now()}.png`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      }catch{ alert('Export failed. If background came from YouTube, try Upload or AI Generate before exporting.'); }
    });

    // ===== Templates =====
    $('tplElementary').addEventListener('click', () => {
      state.primary = '#0ea5e9'; state.secondary = '#082f49'; state.text = '#ffffff';
      state.title = "Ms. Rivera's Art Class"; state.subtitle = 'Making Waves with Creativity';
      state.layout = 'left'; state.strokeWidth = 8; state.shadow = 'on';
      $('title').value = state.title; $('subtitle').value = state.subtitle;
      $('colorPrimary').value = state.primary; $('colorSecondary').value = state.secondary; $('colorText').value = state.text;
      $('layout').value = state.layout; $('strokeWidth').value = String(state.strokeWidth); $('lblStroke').textContent = String(state.strokeWidth);
      draw();
    });
    $('tplSecondary').addEventListener('click', () => {
      state.primary = '#001f3f'; state.secondary = '#003f6b'; state.text = '#ffffff';
      state.title = 'Secondary Campus News'; state.subtitle = 'Dress-Down Fridays • Sports • Clubs';
      state.layout = 'center'; state.strokeWidth = 10; state.shadow = 'on';
      $('title').value = state.title; $('subtitle').value = state.subtitle;
      $('colorPrimary').value = state.primary; $('colorSecondary').value = state.secondary; $('colorText').value = state.text;
      $('layout').value = state.layout; $('strokeWidth').value = String(state.strokeWidth); $('lblStroke').textContent = String(state.strokeWidth);
      draw();
    });
    $('tplAthletics').addEventListener('click', () => {
      state.primary = '#111827'; state.secondary = '#0ea5e9'; state.text = '#ffffff';
      state.title = 'PBMA Athletics'; state.subtitle = 'Game Day Highlights';
      state.layout = 'right'; state.strokeWidth = 12; state.shadow = 'on';
      $('title').value = state.title; $('subtitle').value = state.subtitle;
      $('colorPrimary').value = state.primary; $('colorSecondary').value = state.secondary; $('colorText').value = state.text;
      $('layout').value = state.layout; $('strokeWidth').value = String(state.strokeWidth); $('lblStroke').textContent = String(state.strokeWidth);
      draw();
    });

    // ===== Tests (sanity) =====
    function runTests(){
      const tests=[]; const t=(n,f)=>{ try{const r=f(); tests.push({n,ok:r===true});}catch(e){tests.push({n,ok:false});} };
      const cases=[['dQw4w9WgXcQ','dQw4w9WgXcQ'],['https://www.youtube.com/watch?v=dQw4w9WgXcQ','dQw4w9WgXcQ'],['https://youtu.be/dQw4w9WgXcQ','dQw4w9WgXcQ'],['https://www.youtube.com/watch?v=dQw4w9WgXcQ&t=60s','dQw4w9WgXcQ'],['https://m.youtube.com/watch?v=dQw4w9WgXcQ','dQw4w9WgXcQ'],['https://www.youtube.com/shorts/dQw4w9WgXcQ?si=abc','dQw4w9WgXcQ'],['https://www.youtube.com/embed/dQw4w9WgXcQ','dQw4w9WgXcQ'],['   dQw4w9WgXcQ   ','dQw4w9WgXcQ'],['not-a-url-or-id',null],['short-id',null]];
      for(const [inp,exp] of cases){t(`extract(${inp})`,()=>extractYouTubeId(inp)===exp);}
      t('stretch',()=>{const r=coverContainRect(100,50,200,100,'stretch');return r.dWidth===200&&r.dHeight===100;});
      t('contain tall',()=>{const r=coverContainRect(100,200,200,100,'contain');return r.dx===75&&r.dy===0&&Math.round(r.dWidth)===50&&Math.round(r.dHeight)===100;});
      t('cover wide',()=>{const r=coverContainRect(400,100,200,100,'cover');return Math.round(r.sWidth)===200&&Math.round(r.sHeight)===100;});
      $('tests').textContent=tests.map(x=>`${x.ok?'✅':'❌'} ${x.n}`).join('\n');
      return tests.every(x=>x.ok);
    }

    // Init
    const canvas=$('canvas');
    draw(); runTests();
  </script>
</body>
</html>
